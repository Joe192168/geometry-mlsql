<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geominfo.mlsql.dao.TSystemResourcesDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.geominfo.mlsql.domain.po.TSystemResources">
        <id column="id" property="id"/>
        <result column="parentid" property="parentId"/>
        <result column="resource_type_id" property="resourceTypeId"/>
        <result column="resource_name" property="resourceName"/>
        <result column="display_name" property="displayName"/>
        <result column="display_order" property="displayOrder"/>
        <result column="description" property="description"/>
        <result column="display_img" property="displayImg"/>
        <result column="resource_level" property="resourceLevel"/>
        <result column="is_inner_resource" property="isInnerResource"/>
        <result column="owner" property="owner"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="last_editor" property="lastEditor"/>
        <result column="resource_state" property="resourceState"/>
        <result column="external_app_info" property="externalAppInfo"/>
        <result column="derive_resource_id" property="deriveResourceId"/>
        <result column="content_info" property="contentInfo"/>
    </resultMap>

    <select id="listByParentId" resultType="com.geominfo.mlsql.domain.po.TSystemResources">
        select tt.id,tt.parentId,tt.resource_name,tt.resource_type_id,tt.owner from (
        with RECURSIVE t as
        (
        select a.* from t_system_resources a where a.id = #{parentId}
        union all
        select k.*  from t_system_resources k , t where t.id =k.parentid
        )
        select * from t
        ) tt
        where 1=1 and (tt.resource_state = 0 or tt.resource_state is null ) order by tt.id
    </select>


    <select id="selectScriptByRoute" resultType="com.geominfo.mlsql.domain.po.TSystemResources">
        SELECT * FROM t_system_resources sr where  json_in_varchar(sr.content_info) ->> 'src' = #{scriptRoute} and resource_type_id = #{resourceId}
    </select>
    <select id="checkSystemParamName" parameterType="com.geominfo.mlsql.domain.vo.CheckParamVo"
            resultType="com.geominfo.mlsql.domain.vo.SystemResourceVo">
        select *
        from t_system_resources
        where resource_type_id = #{resourceType}
        and resource_name = #{paramName}
        <if test="parentId != null">
            and parentid = #{parentId}
        </if>
    </select>

    <select id="getWorkSpaceLists" parameterType="java.lang.Integer"
            resultType="com.geominfo.mlsql.domain.result.WorkSpaceInfoResult">
        select tsr.id spaceId,
               tsr.resource_name spaceName,
               tsr.owner spaceOwnerId,
               tsr.content_info  describe,
               tsr.create_time createTime,
               tsr.update_time  updateTime,
              (select twmi.state  from t_workspace_member_infos twmi where tsr.id = twmi.space_id and twmi.space_member_id = #{userId}) spaceState,
              (select count(*) from t_workspace_member_infos twmi where tsr.id = twmi.space_id and twmi.space_member_id = #{userId}) spaceMemberNum
        from t_system_resources tsr
        where tsr.resource_type_id = 42
              and tsr.id in (
                select twmi.space_id
                from t_workspace_member_infos twmi
                where twmi.space_member_id = #{userId}
              )
    </select>

    <select id="getWorkSpaceListsByName"
            resultType="com.geominfo.mlsql.domain.result.WorkSpaceInfoResult">
        select tsr.id spaceId,
        tsr.resource_name spaceName,
        tsr.owner spaceOwnerId,
        tsr.content_info describe,
        tsr.create_time createTime,
        tsr.update_time updateTime,
        (select twmi.state from t_workspace_member_infos twmi where tsr.id = twmi.space_id and twmi.space_member_id =
        #{userId}) spaceState,
        (select count(*) from t_workspace_member_infos twmi where tsr.id = twmi.space_id and twmi.space_member_id =
        #{userId}) spaceMemberNum
        from t_system_resources tsr
        left join t_workspace_member_infos twmi on tsr.id = twmi.space_id
        where tsr.resource_type_id = 42
        and tsr.id in (
        select distinct (twmi.space_id)
        from t_workspace_member_infos twmi
        where twmi.space_member_id = #{userId}
        )
        <if test="spaceName != null">
            and LOWER (resource_name) LIKE '%'||#{spaceName}||'%'
        </if>
    </select>

    <select id="getAllRecoverResources" resultType="com.geominfo.mlsql.domain.po.TSystemResources">
                select tt.id,tt.parentId,tt.resource_name,tt.resource_type_id,tt.owner,tt.create_time,tt.update_time,tt.content_info from (
        with RECURSIVE t as
        (
        select a.* from t_system_resources a where a.id = #{workSpaceId}
        union all
        select k.*  from t_system_resources k , t where t.id =k.parentid
        )
        select * from t
        ) tt
        where 1=1 and tt.resource_state = 1 and owner = #{userId} order by tt.id
    </select>

    <select id="getRecentlyScripts" parameterType="java.lang.Integer"
            resultType="com.geominfo.mlsql.domain.po.TSystemResources">
        select * FROM t_system_resources WHERE id in (
        WITH RECURSIVE r AS (
        SELECT * FROM t_system_resources WHERE id in (
        select distinct(twmi.space_id) from t_workspace_member_infos twmi  where space_member_id = #{userId}
        )
        union ALL
        SELECT ts.* FROM t_system_resources ts, r WHERE ts.parentid = r.id
        )
        SELECT r.id
        FROM r
        where r.resource_type_id = 41
        and r.resource_state = 1
        order by update_time desc
        )
        limit 10
    </select>


</mapper>